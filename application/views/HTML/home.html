<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanAction - Social Impact Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-black': '#0a0a0a',
                        'brand-dark': '#121212',
                        'brand-green': '#10b981', 
                        'brand-red': '#ef4444',
                        'brand-yellow': '#f59e0b',
                        'admin-dark': '#1f2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Oswald', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #10b981; }
        .hero-overlay { background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(10,10,10,1) 100%); }
        #map { height: 400px; width: 100%; z-index: 1; }
        .ba-slider { position: relative; width: 100%; height: 300px; overflow: hidden; cursor: col-resize; }
        .ba-slider img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .ba-before { z-index: 2; clip-path: inset(0 50% 0 0); width: 100%; }
        .ba-handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 4px; background: #fff; z-index: 10; display: flex; align-items: center; justify-content: center; }
        .ba-circle { width: 30px; height: 30px; background: #10b981; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: 2px solid white; }
        .sidebar-link.active { background-color: #10b981; color: black; font-weight: bold; }
    </style>
</head>
<body class="bg-brand-black text-white font-sans antialiased selection:bg-brand-green selection:text-black">

    <!-- Navbar -->
    <nav id="navbar" class="fixed w-full z-50 transition-all duration-300 py-4 px-6 md:px-12 flex justify-between items-center backdrop-blur-sm bg-black/30 border-b border-white/10">
        <div class="flex items-center gap-2 cursor-pointer" onclick="window.scrollTo(0,0)">
            <div class="w-8 h-8 bg-white text-black flex items-center justify-center font-bold rounded-sm">P</div>
            <span class="font-heading text-xl tracking-wider font-bold uppercase">Pandawara <span class="text-brand-green">Style</span></span>
        </div>
        <div class="hidden md:flex gap-6 text-sm font-semibold tracking-wide uppercase text-gray-300">
            <a href="#transparency" class="hover:text-brand-green transition-colors">Transparansi</a>
            <a href="#report" class="hover:text-brand-green transition-colors">Lapor Sampah</a>
            <a href="#volunteer" class="hover:text-brand-green transition-colors">Relawan</a>
            <button onclick="toggleAdminPanel()" class="text-xs border border-gray-600 px-3 py-1 rounded hover:bg-brand-green hover:text-black hover:border-brand-green transition-all text-gray-500 font-bold uppercase">
                <i class="fas fa-database mr-1"></i> Admin (DB View)
            </button>
        </div>
        <button class="md:hidden text-2xl"><i class="fas fa-bars"></i></button>
    </nav>

    <!-- Hero -->
    <section id="home" class="relative min-h-[80vh] flex items-center justify-center px-6 overflow-hidden">
        <div class="absolute inset-0 z-0">
            <img src="https://images.unsplash.com/photo-1618477461853-5f87b7852ecf?q=80&w=2574&auto=format&fit=crop" class="w-full h-full object-cover opacity-60">
        </div>
        <div class="absolute inset-0 hero-overlay z-10"></div>
        <div class="relative z-20 text-center max-w-4xl mx-auto mt-16">
            <p class="text-brand-green font-bold tracking-[0.2em] mb-4 uppercase">Social Impact Database</p>
            <h1 class="font-heading text-5xl md:text-7xl font-bold uppercase leading-tight mb-6">
                Transparansi <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-green to-teal-500">Nyata</span><br>
                Aksi <span class="text-white">Terdata</span>
            </h1>
            <div class="flex gap-4 justify-center">
                <a href="#report" class="px-8 py-3 bg-brand-green text-black font-bold uppercase hover:bg-white transition-all">Lapor (GIS)</a>
                <a href="#transparency" class="px-8 py-3 border border-white text-white font-bold uppercase hover:bg-white/10 transition-all">Cek Data</a>
            </div>
        </div>
    </section>

    <!-- Fitur 1: Transparansi (Donations & Expenses Tables) -->
    <section id="transparency" class="py-20 px-6 bg-brand-black border-t border-gray-800">
        <div class="max-w-7xl mx-auto">
            <div class="mb-12 text-center md:text-left">
                <h2 class="font-heading text-4xl font-bold uppercase text-brand-green mb-2">Keuangan & Transparansi</h2>
                <p class="text-gray-400">Data diambil langsung dari tabel <code class="bg-gray-800 px-1 rounded text-xs text-yellow-500">donations</code> dan <code class="bg-gray-800 px-1 rounded text-xs text-yellow-500">expenses</code>.</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
                <!-- Saldo Real-time -->
                <div class="bg-brand-dark p-6 rounded-lg border border-white/10">
                    <h3 class="font-bold text-lg mb-4 text-center">Status Akun (Table: accounts)</h3>
                    <div class="flex flex-col items-center justify-center h-48">
                        <p class="text-sm text-gray-500 mb-1" id="acc_name_display">Loading...</p>
                        <h2 class="text-4xl font-heading font-bold text-white mb-2" id="acc_balance_display">Rp 0</h2>
                        <span class="text-xs bg-brand-green text-black px-2 py-1 rounded font-bold">ACTIVE</span>
                    </div>
                </div>

                <!-- Grafik Alokasi -->
                <div class="bg-brand-dark p-6 rounded-lg border border-white/10">
                    <h3 class="font-bold text-lg mb-4 text-center">Alokasi (Table: expenses)</h3>
                    <div class="h-48">
                        <canvas id="allocationChart"></canvas>
                    </div>
                </div>

                <!-- Form Donasi -->
                <div class="bg-brand-dark p-6 rounded-lg border border-brand-green/30 relative overflow-hidden">
                    <h3 class="font-bold text-lg mb-4 uppercase">Insert to `donations`</h3>
                    <p class="text-xs text-gray-400 mb-4" id="bankDetailsDisplay">Loading Account...</p>
                    <form id="donationForm" class="space-y-4 relative z-10" onsubmit="handleDonation(event)">
                        <input type="text" id="donor_name" placeholder="donor_name (Optional)" class="w-full bg-black border border-gray-700 p-3 rounded focus:border-brand-green outline-none text-sm">
                        <input type="email" id="donor_email" placeholder="donor_email" class="w-full bg-black border border-gray-700 p-3 rounded focus:border-brand-green outline-none text-sm" required>
                        <div class="relative">
                            <span class="absolute left-3 top-3 text-gray-500">Rp</span>
                            <input type="number" id="amount" placeholder="amount" class="w-full bg-black border border-gray-700 p-3 pl-10 rounded focus:border-brand-green outline-none text-sm" required>
                        </div>
                        <input type="text" id="message" placeholder="message (Doa/Dukungan)" class="w-full bg-black border border-gray-700 p-3 rounded focus:border-brand-green outline-none text-sm">
                        <button type="submit" class="w-full bg-brand-green text-black font-bold py-3 rounded hover:bg-white transition-colors">INSERT DATA</button>
                    </form>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Wall of Donors -->
                <div>
                    <h3 class="font-heading text-xl uppercase mb-4 border-l-4 border-brand-green pl-3">Donasi Masuk (Verified)</h3>
                    <div class="bg-brand-dark rounded-lg p-4 h-80 overflow-y-auto border border-white/10" id="donorWall">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Expense Timeline -->
                <div>
                    <h3 class="font-heading text-xl uppercase mb-4 border-l-4 border-white pl-3">Penggunaan Dana (Expenses)</h3>
                    <div class="bg-brand-dark rounded-lg p-4 h-80 overflow-y-auto border border-white/10 relative space-y-6" id="expenseTimeline">
                        <!-- Injected via JS -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Fitur 2: Waste Reports (Table: waste_reports) -->
    <section id="report" class="py-20 px-6 bg-brand-dark">
        <div class="max-w-7xl mx-auto">
            <h2 class="font-heading text-4xl font-bold uppercase text-white mb-2">GIS & Laporan Sampah</h2>
            <p class="text-gray-400 mb-8">Visualisasi data dari tabel <code class="bg-gray-800 px-1 rounded text-xs text-yellow-500">waste_reports</code>.</p>

            <div class="bg-gray-800 rounded-lg overflow-hidden border border-white/20 mb-12 shadow-2xl">
                <div id="map"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Form Report -->
                <div>
                    <h3 class="font-heading text-2xl uppercase mb-4">Insert to `waste_reports`</h3>
                    <form id="reportForm" class="bg-brand-black p-6 rounded border border-white/10 space-y-4" onsubmit="handleReport(event)">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="reporter_name" placeholder="reporter_name" class="bg-brand-dark border border-gray-700 p-3 rounded w-full">
                            <input type="text" id="reporter_contact" placeholder="reporter_contact" class="bg-brand-dark border border-gray-700 p-3 rounded w-full">
                        </div>
                        <input type="text" id="location_address" placeholder="location_address (Nama Tempat/Jalan)" class="bg-brand-dark border border-gray-700 p-3 rounded w-full">
                        <div class="flex gap-2">
                            <input type="text" id="latitude" placeholder="latitude" class="bg-brand-dark border border-gray-700 p-3 rounded w-1/2" readonly>
                            <input type="text" id="longitude" placeholder="longitude" class="bg-brand-dark border border-gray-700 p-3 rounded w-1/2" readonly>
                            <button type="button" onclick="getLocation()" class="bg-white text-black px-4 rounded font-bold text-xs uppercase hover:bg-gray-200">GPS</button>
                        </div>
                        <textarea id="description" placeholder="description" class="bg-brand-dark border border-gray-700 p-3 rounded w-full h-24"></textarea>
                        <button type="submit" class="w-full bg-brand-red text-white font-bold py-3 rounded hover:bg-red-600 transition-colors uppercase tracking-wider">SUBMIT REPORT</button>
                    </form>
                </div>

                <!-- Slider Generated from DB -->
                <div>
                    <h3 class="font-heading text-2xl uppercase mb-4">Resolved Reports (With Images)</h3>
                    <div id="slider-container" class="space-y-8">
                        <!-- Sliders injected based on waste_reports where image_after_url is not null -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Fitur 3: Events (Table: volunteer_events) -->
    <section id="volunteer" class="py-20 px-6 bg-brand-black">
        <div class="max-w-7xl mx-auto">
            <h2 class="font-heading text-4xl font-bold uppercase text-center mb-12">Volunteer Events</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="eventList">
                <!-- Events injected via JS -->
            </div>
        </div>
    </section>

    <!-- Admin Dashboard (Simulated DB View) -->
    <div id="adminPanel" class="fixed inset-0 bg-brand-black z-[100] hidden flex overflow-hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-admin-dark border-r border-gray-700 flex flex-col hidden md:flex">
            <div class="p-6 border-b border-gray-700">
                <span class="font-heading text-xl font-bold uppercase tracking-wider">DB <span class="text-brand-green">Admin</span></span>
            </div>
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="switchAdminTab('overview')" class="sidebar-link active w-full text-left px-4 py-3 rounded text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-3">
                    <i class="fas fa-table w-5"></i> Overview
                </button>
                <button onclick="switchAdminTab('expenses')" class="sidebar-link w-full text-left px-4 py-3 rounded text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-3">
                    <i class="fas fa-file-invoice-dollar w-5"></i> Expenses Table
                </button>
                <button onclick="switchAdminTab('reports')" class="sidebar-link w-full text-left px-4 py-3 rounded text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-3">
                    <i class="fas fa-map-marked-alt w-5"></i> Reports Table
                </button>
                <button onclick="switchAdminTab('events')" class="sidebar-link w-full text-left px-4 py-3 rounded text-sm text-gray-300 hover:bg-gray-700 flex items-center gap-3">
                    <i class="fas fa-calendar w-5"></i> Events Table
                </button>
            </nav>
            <div class="p-4 border-t border-gray-700">
                <button onclick="toggleAdminPanel()" class="w-full px-4 py-2 bg-red-900/50 text-red-400 border border-red-900 rounded text-sm">Close DB View</button>
            </div>
        </div>

        <!-- Content -->
        <div class="flex-1 flex flex-col h-full overflow-hidden">
            <div class="md:hidden bg-admin-dark p-4 flex justify-between items-center border-b border-gray-700">
                <span class="font-bold">Database Admin</span>
                <button onclick="toggleAdminPanel()" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6 md:p-10 bg-brand-black">
                
                <!-- Overview -->
                <div id="admin-overview" class="admin-tab-content">
                    <h2 class="text-2xl font-heading font-bold mb-6">Database Summary</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                        <div class="bg-admin-dark p-4 rounded border border-gray-700">
                            <p class="text-gray-500 text-xs uppercase">Rows in `donations`</p>
                            <h3 class="text-xl font-bold text-white" id="count-donations">0</h3>
                        </div>
                        <div class="bg-admin-dark p-4 rounded border border-gray-700">
                            <p class="text-gray-500 text-xs uppercase">Rows in `expenses`</p>
                            <h3 class="text-xl font-bold text-white" id="count-expenses">0</h3>
                        </div>
                        <div class="bg-admin-dark p-4 rounded border border-gray-700">
                            <p class="text-gray-500 text-xs uppercase">Rows in `waste_reports`</p>
                            <h3 class="text-xl font-bold text-white" id="count-reports">0</h3>
                        </div>
                         <div class="bg-admin-dark p-4 rounded border border-gray-700">
                            <p class="text-gray-500 text-xs uppercase">Rows in `volunteer_events`</p>
                            <h3 class="text-xl font-bold text-white" id="count-events">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Expenses Table Management -->
                <div id="admin-expenses" class="admin-tab-content hidden">
                    <h2 class="text-2xl font-heading font-bold mb-6">Insert into `expenses`</h2>
                    <form onsubmit="addExpense(event)" class="bg-admin-dark p-6 rounded border border-gray-700 mb-8 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" id="exp_title" placeholder="title" class="bg-black border border-gray-600 p-2 rounded text-sm text-white">
                            <input type="number" id="exp_amount" placeholder="amount" class="bg-black border border-gray-600 p-2 rounded text-sm text-white">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <select id="exp_category" class="bg-black border border-gray-600 p-2 rounded text-sm text-white">
                                <option value="operational">operational</option>
                                <option value="equipment">equipment</option>
                                <option value="logistics">logistics</option>
                                <option value="administration">administration</option>
                                <option value="others">others</option>
                            </select>
                            <input type="date" id="exp_date" class="bg-black border border-gray-600 p-2 rounded text-sm text-white text-gray-400">
                        </div>
                        <button type="submit" class="w-full bg-red-900/50 text-red-400 border border-red-900 hover:bg-red-900 py-2 rounded text-sm">INSERT</button>
                    </form>
                </div>
                
                 <!-- Reports Table Management -->
                 <div id="admin-reports" class="admin-tab-content hidden">
                    <h2 class="text-2xl font-heading font-bold mb-6">Manage `waste_reports`</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-gray-400">
                            <thead class="bg-gray-800 text-white uppercase text-xs">
                                <tr>
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Location Address</th>
                                    <th class="p-3">Status</th>
                                    <th class="p-3">Action</th>
                                </tr>
                            </thead>
                            <tbody id="admin-reports-tbody">
                                <!-- Injected via JS -->
                            </tbody>
                        </table>
                    </div>
                </div>

                 <!-- Events Table Management -->
                 <div id="admin-events" class="admin-tab-content hidden">
                    <h2 class="text-2xl font-heading font-bold mb-6">Insert into `volunteer_events`</h2>
                    <form onsubmit="addEvent(event)" class="bg-admin-dark p-6 rounded border border-gray-700 mb-8 space-y-4">
                        <input type="text" id="evt_name" placeholder="event_name" class="bg-black border border-gray-600 p-2 rounded text-sm text-white w-full">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="datetime-local" id="evt_date" class="bg-black border border-gray-600 p-2 rounded text-sm text-white w-full text-gray-400">
                            <input type="text" id="evt_loc" placeholder="location" class="bg-black border border-gray-600 p-2 rounded text-sm text-white w-full">
                        </div>
                        <button type="submit" class="w-full bg-brand-green text-black font-bold py-2 rounded text-sm">INSERT</button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- Receipt Modal -->
    <div id="receiptModal" class="fixed inset-0 bg-black/90 z-[150] hidden flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-white p-4 max-w-sm w-full relative" onclick="event.stopPropagation()">
            <button onclick="document.getElementById('receiptModal').classList.add('hidden')" class="absolute top-2 right-2 text-black font-bold">X</button>
            <h3 class="text-black font-bold text-center mb-2 uppercase border-b pb-2">Receipt Evidence</h3>
            <div class="h-48 bg-gray-200 flex items-center justify-center text-gray-500 mb-2 border border-gray-300">
                <i class="fas fa-image text-4xl"></i>
            </div>
            <p class="text-black text-xs font-mono">Date: <span id="receiptDate"></span></p>
        </div>
    </div>

    <script>
        // --- 1. SIMULATED DATABASE (Strictly matching SQL Schema) ---
        
        // Table: accounts
        let db_accounts = [
            { id: 1, account_name: 'BCA Foundation', account_type: 'bank', account_number: '888-222-111', account_holder_name: 'Green Earth Foundation', current_balance: 0, is_active: 1 }
        ];

        // Table: donations
        let db_donations = [
            { id: 1, donor_name: "Hamba Allah", donor_email: "anon@mail.com", amount: 500000, account_id: 1, status: 'verified', created_at: "2023-12-04 10:00:00" },
            { id: 2, donor_name: "Budi Santoso", donor_email: "budi@mail.com", amount: 1000000, account_id: 1, status: 'verified', created_at: "2023-12-04 09:30:00" }
        ];

        // Table: expenses
        let db_expenses = [
            { id: 1, title: "50 Karung & Sarung Tangan", description: "Beli di Toko Jaya", amount: 500000, category: 'equipment', transaction_date: "2023-10-24", account_id: 1, receipt_image_url: "path/to/img.jpg" },
            { id: 2, title: "Sewa Truk Sampah", description: "Sewa harian", amount: 1500000, category: 'operational', transaction_date: "2023-10-22", account_id: 1, receipt_image_url: "path/to/img2.jpg" }
        ];

        // Table: waste_reports (Used for GIS Map and Before/After Slider)
        let db_waste_reports = [
            { id: 1, reporter_name: "Anonim", location_address: "Tumpukan Sampah Cempaka", latitude: -6.175110, longitude: 106.865036, status: 'pending', description: "Bau menyengat", image_before_url: "https://images.unsplash.com/photo-1621451537084-482c73073a0f?q=80&w=600&grayscale", image_after_url: null, created_at: "2023-11-01" },
            { id: 2, reporter_name: "Admin", location_address: "Sungai Citarum Sektor 4", latitude: -6.225000, longitude: 106.800000, status: 'resolved', description: "Sudah bersih total", image_before_url: "https://images.unsplash.com/photo-1621451537084-482c73073a0f?q=80&w=600&grayscale", image_after_url: "https://images.unsplash.com/photo-1618477461853-5f87b7852ecf?q=80&w=600", cleaned_at: "2023-11-05" }
        ];

        // Table: volunteer_events
        let db_volunteer_events = [
            { id: 1, event_name: "Bersih Pantai Indah", description: "Kegiatan rutin", event_date: "2023-11-12 08:00:00", location: "Pantai Indah Kapuk 2", status: 'upcoming' },
            { id: 2, event_name: "Operasi Semut Sungai", description: "Bawa botol minum", event_date: "2023-11-15 07:00:00", location: "Bantaran Ciliwung", status: 'upcoming' }
        ];


        // --- 2. LOGIC & INITIALIZATION ---

        // Chart Init
        const ctxAlloc = document.getElementById('allocationChart').getContext('2d');
        let chartAlloc;

        function initData() {
            calculateBalance();
            renderCharts();
            renderDonors();
            renderExpenses();
            initMap();
            renderEventList();
            renderSliders(); // Derived from waste_reports
            renderBankInfo();
            updateAdminCounts();
        }

        function calculateBalance() {
            // Recalculate account balance based on donations - expenses
            const totalIn = db_donations.filter(d => d.status === 'verified').reduce((sum, d) => sum + d.amount, 0);
            const totalOut = db_expenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Update db_accounts (assuming single account for demo)
            db_accounts[0].current_balance = totalIn - totalOut;
            
            // UI Update
            document.getElementById('acc_balance_display').innerText = "Rp " + db_accounts[0].current_balance.toLocaleString('id-ID');
        }

        function renderBankInfo() {
            const acc = db_accounts[0];
            document.getElementById('bankDetailsDisplay').innerText = `Transfer to: ${acc.account_name} (${acc.account_type.toUpperCase()}) - ${acc.account_number}`;
            document.getElementById('acc_name_display').innerText = acc.account_name + " - " + acc.account_number;
        }

        function renderCharts() {
            // Group expenses by category
            const categories = ['operational', 'equipment', 'logistics', 'administration', 'others'];
            const data = categories.map(cat => 
                db_expenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0)
            );

            if (chartAlloc) chartAlloc.destroy();
            chartAlloc = new Chart(ctxAlloc, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#f59e0b', '#3b82f6', '#10b981', '#6366f1', '#9ca3af'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: 'white', font: { size: 10 } } } } }
            });
        }

        // --- MAP & REPORTS ---
        let map;
        function initMap() {
            map = L.map('map').setView([-6.175110, 106.825036], 11);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap',
                maxZoom: 19
            }).addTo(map);
            renderMarkers();
        }

        function renderMarkers() {
            map.eachLayer((layer) => { if(layer instanceof L.Marker) map.removeLayer(layer); });

            db_waste_reports.forEach(r => {
                let color = r.status === 'pending' ? '#ef4444' : (r.status === 'in_progress' ? '#f59e0b' : '#10b981'); // pending=red, in_progress=yellow, resolved=green
                const iconHtml = `<div style="background-color: ${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px ${color};"></div>`;
                const customIcon = L.divIcon({ html: iconHtml, className: 'custom-marker-icon' });
                L.marker([r.latitude, r.longitude], { icon: customIcon }).addTo(map)
                    .bindPopup(`<div style="color:black"><b>${r.location_address}</b><br><small>${r.description}</small><br><small class="uppercase font-bold" style="color:${color}">${r.status}</small></div>`);
            });
        }

        // --- UI LISTS ---
        function renderDonors() {
            const container = document.getElementById('donorWall');
            container.innerHTML = '';
            // Show latest first
            [...db_donations].reverse().forEach(d => {
                if(d.status === 'verified') {
                    container.innerHTML += `
                        <div class="flex justify-between items-center mb-3 border-b border-gray-800 pb-2">
                            <div>
                                <p class="font-bold text-sm text-white">${d.donor_name}</p>
                                <p class="text-xs text-gray-500">${d.created_at}</p>
                            </div>
                            <p class="text-brand-green font-mono font-bold text-sm">+Rp ${d.amount.toLocaleString()}</p>
                        </div>`;
                }
            });
        }

        function renderExpenses() {
            const container = document.getElementById('expenseTimeline');
            container.innerHTML = '';
            [...db_expenses].reverse().forEach(e => {
                container.innerHTML += `
                    <div class="relative pl-6 border-l border-gray-700">
                        <div class="absolute -left-1.5 top-1 w-3 h-3 bg-white rounded-full"></div>
                        <p class="text-xs text-gray-400 mb-1">${e.transaction_date} â€¢ <span class="text-blue-400 uppercase">${e.category}</span></p>
                        <h4 class="font-bold text-white text-sm">${e.title}</h4>
                        <div class="flex justify-between items-center mt-1">
                            <p class="text-red-400 font-mono text-sm">-Rp ${e.amount.toLocaleString()}</p>
                            <button onclick="document.getElementById('receiptModal').classList.remove('hidden'); document.getElementById('receiptDate').innerText='${e.transaction_date}'" class="text-[10px] border border-gray-600 px-2 py-0.5 rounded hover:bg-white hover:text-black transition-colors">Receipt</button>
                        </div>
                    </div>`;
            });
        }

        function renderEventList() {
            const container = document.getElementById('eventList');
            container.innerHTML = '';
            db_volunteer_events.forEach(ev => {
                container.innerHTML += `
                    <div class="bg-brand-dark p-6 border border-brand-green/30 rounded-lg group relative overflow-hidden">
                        <div class="flex justify-between items-start mb-4 relative z-10">
                            <div class="bg-brand-green text-black font-bold px-3 py-1 text-xs rounded uppercase tracking-wider">${ev.status}</div>
                        </div>
                        <h3 class="text-xl font-heading font-bold uppercase mb-2 relative z-10">${ev.event_name}</h3>
                        <p class="text-gray-400 text-sm mb-1"><i class="fas fa-calendar-alt mr-2 text-brand-green"></i> ${ev.event_date.replace('T', ' ')}</p>
                        <p class="text-gray-400 text-sm mb-6"><i class="fas fa-map-marker-alt mr-2 text-brand-green"></i> ${ev.location}</p>
                        <button class="w-full bg-white text-black font-bold py-3 rounded uppercase text-xs hover:bg-brand-green transition-colors">Register</button>
                    </div>`;
            });
        }

        function renderSliders() {
            const container = document.getElementById('slider-container');
            container.innerHTML = '';
            // Only show reports that have an 'image_after_url' (meaning they are resolved/cleaned)
            const resolvedReports = db_waste_reports.filter(r => r.image_after_url);
            
            resolvedReports.forEach((r, index) => {
                container.innerHTML += `
                    <div class="mb-8">
                        <p class="text-sm font-bold uppercase mb-2 text-brand-green"><i class="fas fa-check-circle"></i> ${r.location_address}</p>
                        <div class="ba-slider rounded-lg border border-white/20" onmousemove="moveSlider(event, this)" ontouchmove="moveSlider(event, this)">
                            <img src="${r.image_after_url}" alt="After" draggable="false">
                            <div class="ba-before">
                                <img src="${r.image_before_url}" alt="Before" draggable="false">
                            </div>
                            <div class="ba-handle"><div class="ba-circle"><i class="fas fa-arrows-left-right text-xs"></i></div></div>
                        </div>
                    </div>`;
            });
        }

        function moveSlider(e, element) {
            const rect = element.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            let percent = Math.max(0, Math.min(100, (x / rect.width) * 100));
            element.querySelector('.ba-before').style.clipPath = `inset(0 ${100 - percent}% 0 0)`;
            element.querySelector('.ba-handle').style.left = `${percent}%`;
        }

        // --- FORM HANDLERS ---
        function handleDonation(e) {
            e.preventDefault();
            const name = document.getElementById('donor_name').value || 'Anonymous';
            const email = document.getElementById('donor_email').value;
            const amount = parseInt(document.getElementById('amount').value);
            const msg = document.getElementById('message').value;

            // Insert into db_donations
            db_donations.push({
                id: db_donations.length + 1,
                donor_name: name,
                donor_email: email,
                amount: amount,
                account_id: 1,
                status: 'verified', // Auto-verify for demo
                created_at: new Date().toISOString().replace('T', ' ').substring(0, 19)
            });

            e.target.reset();
            calculateBalance();
            renderDonors();
            updateAdminCounts();
            alert("Donation Inserted Successfully!");
        }

        function handleReport(e) {
            e.preventDefault();
            const reporter = document.getElementById('reporter_name').value;
            const address = document.getElementById('location_address').value;
            const lat = parseFloat(document.getElementById('latitude').value);
            const lng = parseFloat(document.getElementById('longitude').value);
            const desc = document.getElementById('description').value;

            // Insert into db_waste_reports
            db_waste_reports.push({
                id: db_waste_reports.length + 1,
                reporter_name: reporter,
                location_address: address,
                latitude: lat,
                longitude: lng,
                status: 'pending',
                description: desc,
                image_before_url: "https://images.unsplash.com/photo-1621451537084-482c73073a0f?q=80&w=600&grayscale", // Placeholder
                image_after_url: null,
                created_at: new Date().toISOString()
            });

            e.target.reset();
            renderMarkers();
            renderAdminReportsTable();
            updateAdminCounts();
            alert("Report Inserted into `waste_reports` with status: pending");
        }

        function addExpense(e) {
            e.preventDefault();
            const title = document.getElementById('exp_title').value;
            const amount = parseInt(document.getElementById('exp_amount').value);
            const cat = document.getElementById('exp_category').value;
            const date = document.getElementById('exp_date').value;

            db_expenses.push({
                id: db_expenses.length + 1,
                title: title,
                amount: amount,
                category: cat,
                transaction_date: date,
                account_id: 1,
                receipt_image_url: ""
            });

            e.target.reset();
            calculateBalance();
            renderExpenses();
            renderCharts();
            updateAdminCounts();
            alert("Expense Inserted!");
        }

        function addEvent(e) {
            e.preventDefault();
            const name = document.getElementById('evt_name').value;
            const date = document.getElementById('evt_date').value;
            const loc = document.getElementById('evt_loc').value;

            db_volunteer_events.push({
                id: db_volunteer_events.length + 1,
                event_name: name,
                event_date: date,
                location: loc,
                status: 'upcoming'
            });

            e.target.reset();
            renderEventList();
            updateAdminCounts();
            alert("Event Inserted!");
        }

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((pos) => {
                    document.getElementById('latitude').value = pos.coords.latitude.toFixed(6);
                    document.getElementById('longitude').value = pos.coords.longitude.toFixed(6);
                    alert("GPS Locked!");
                });
            } else alert("Geolocation not supported.");
        }

        // --- ADMIN PANEL ---
        function toggleAdminPanel() {
            const panel = document.getElementById('adminPanel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                updateAdminCounts();
                renderAdminReportsTable();
            }
        }

        function switchAdminTab(tabName) {
            document.querySelectorAll('.admin-tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-${tabName}`).classList.remove('hidden');
            document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }

        function updateAdminCounts() {
            document.getElementById('count-donations').innerText = db_donations.length;
            document.getElementById('count-expenses').innerText = db_expenses.length;
            document.getElementById('count-reports').innerText = db_waste_reports.length;
            document.getElementById('count-events').innerText = db_volunteer_events.length;
        }

        function renderAdminReportsTable() {
            const tbody = document.getElementById('admin-reports-tbody');
            tbody.innerHTML = '';
            db_waste_reports.forEach(r => {
                tbody.innerHTML += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="p-3">${r.id}</td>
                        <td class="p-3">${r.location_address}</td>
                        <td class="p-3"><span class="px-2 py-1 rounded text-xs font-bold uppercase ${r.status === 'resolved' ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">${r.status}</span></td>
                        <td class="p-3">
                            ${r.status !== 'resolved' ? `<button onclick="resolveReport(${r.id})" class="text-green-400 hover:text-white text-xs border border-green-400 px-2 py-1 rounded">Mark Resolved</button>` : '-'}
                        </td>
                    </tr>`;
            });
        }

        function resolveReport(id) {
            const rep = db_waste_reports.find(r => r.id === id);
            if(rep) {
                rep.status = 'resolved';
                rep.image_after_url = "https://images.unsplash.com/photo-1618477461853-5f87b7852ecf?q=80&w=600"; // Dummy after image
                renderAdminReportsTable();
                renderMarkers();
                renderSliders();
                alert(`Report ID ${id} updated to 'resolved' & image_after_url added.`);
            }
        }

        window.onload = initData;
    </script>
</body>
</html>